---
title: "Covid Analysis"
author: "Monika Zieli≈Ñska"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, include=FALSE}
library(ggplot2)
library(dplyr)
library(readxl)
library(httr)
require(zoo)
library(cowplot)
```

```{r other options}
print.tbl_df <- function(x, ...) {
  print.data.frame(x, ...)
  invisible(x)
}
```

```{r load data, include=FALSE, cache = TRUE}
url_covid <- "http://www.cs.put.poznan.pl/dbrzezinski/teaching/zed/wuhan_blood_sample_data_Jan_Feb_2020.xlsx"
GET(url_covid, write_disk(tf <- tempfile(fileext = ".xlsx")))
data <- read_xlsx(tf)
unlink(tf)
```

```{r data cleaning, include=FALSE}
df <- as_tibble(data)
# replace NA with most recent not-NA prior to it
df$PATIENT_ID <- na.locf(df$PATIENT_ID)
df <- df %>% 
  rename_with(~ tolower(gsub(" ", "_", .x, fixed = TRUE))) %>%
  mutate(survived = ifelse(outcome==0, "yes", "no")) %>%
  mutate(survived = factor(survived)) %>%
  mutate(gender = ifelse(gender==1, "male", "female")) %>%
  mutate(gender = factor(gender)) %>%
  mutate(age_group = case_when(
    age <= 30 ~ "young adult", 
    age < 65 ~ "adult",
    TRUE ~ "elderly")) %>%
  mutate(age_group = factor(age_group, 
                            levels = c("young adult", "adult", "elderly"))) %>%
  select(-c(outcome))

patients_data <- df %>%
  select(c(patient_id, gender, age, age_group, admission_time, discharge_time, survived)) %>%
  unique() %>%
  mutate(length_of_stay = as.numeric(discharge_time - admission_time, units = "days"))
```
## Introduction
The dataset contains blood results of patients admitted to the hospital Tongji (Wuhan, China) between 10 January and 18 February 2020. The data collection method and basic statistics were used in the [article Tan et al](https://www.nature.com/articles/s42256-020-0180-7).

## Patients data
```{r dataset description}
blood_tests_count = count(df)
patients_count = count(patients_data)

```
The dataset contains `r blood_tests_count` blood tests of `r patients_count` patients. 

The patients are categorized by age into young adults (18-30 years), adults (31-65 years) and elderly (> 65 years).

```{r patients data summary}
knitr::kable(summary(patients_data))
```

Looking at the summary, most of the patients are middle or older aged. There are also more males than females and more people survived than not. 

```{r patients data plots}
survival_gender<-ggplot(patients_data, aes(x=gender, fill=survived)) +
  geom_bar(stat='count') + 
  labs(y = "number of patients")

survival_age<-ggplot(patients_data, aes(x=age_group, fill=survived)) +
  geom_bar(stat='count') + 
  labs(y = "number of patients")  +
  theme(legend.position = "none")

plot_grid(survival_age, survival_gender)

ggplot(patients_data, aes(x=gender, fill=survived)) +
  geom_bar(stat='count') + 
  facet_grid(. ~age_group) +
  labs(y = "number of patients") 

```

At first it looks like males are more likely to die, but the survival rates depends mostly on age of the patient. Survival rates for elderly are much worse and most of the patients in this age group are males.

```{r LOS}
ggplot(patients_data, aes(ceiling(length_of_stay), fill=survived)) +
  geom_bar(stat="count") +
  labs(y = "number of patients", x = "length of stay (days)") 
```

There is a high mortality rate for first few days of stay in hospital. As the length of stay gets longer, survival rates get better.

```{r summary}
knitr::kable(summary(df))
```